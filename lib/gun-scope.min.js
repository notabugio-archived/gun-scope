!function(n,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("ramda"),require("zalgo-promise")):"function"==typeof define&&define.amd?define("gun-scope",["ramda","zalgo-promise"],e):"object"==typeof exports?exports["gun-scope"]=e(require("ramda"),require("zalgo-promise")):n["gun-scope"]=e(n.ramda,n["zalgo-promise"])}("undefined"!=typeof self?self:this,function(n,e){return function(n){var e={};function t(r){if(e[r])return e[r].exports;var o=e[r]={i:r,l:!1,exports:{}};return n[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}return t.m=n,t.c=e,t.d=function(n,e,r){t.o(n,e)||Object.defineProperty(n,e,{enumerable:!0,get:r})},t.r=function(n){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})},t.t=function(n,e){if(1&e&&(n=t(n)),8&e)return n;if(4&e&&"object"==typeof n&&n&&n.__esModule)return n;var r=Object.create(null);if(t.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:n}),2&e&&"string"!=typeof n)for(var o in n)t.d(r,o,function(e){return n[e]}.bind(null,o));return r},t.n=function(n){var e=n&&n.__esModule?function(){return n.default}:function(){return n};return t.d(e,"a",e),e},t.o=function(n,e){return Object.prototype.hasOwnProperty.call(n,e)},t.p="",t(t.s=0)}([function(n,e,t){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.query=e.scope=e.now=e.nowOr=e.resolve=e.all=e.Promise=void 0;var r=t(1),o=t(2);function u(n,e){return function(n){if(Array.isArray(n))return n}(n)||function(n,e){var t=[],r=!0,o=!1,u=void 0;try{for(var i,c=n[Symbol.iterator]();!(r=(i=c.next()).done)&&(t.push(i.value),!e||t.length!==e);r=!0);}catch(n){o=!0,u=n}finally{try{r||null==c.return||c.return()}finally{if(o)throw u}}return t}(n,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function i(n){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(n){return typeof n}:function(n){return n&&"function"==typeof Symbol&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n})(n)}var c=o.ZalgoPromise;e.Promise=c;var a=o.ZalgoPromise.all,f=o.ZalgoPromise.resolve;e.resolve=f,e.all=a;var l=function(n){return Object.keys(n||{}).filter(function(n){return n&&"_"!==n&&"#"!==n})},p=(0,r.curry)(function(n,e){var t,r;return e.then(function(n){r=!0,t=n}),r?t:n});e.nowOr=p;var s=p(void 0);e.now=s;var y=function n(e,t){var u,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(!t||t===[])throw new Error("bad key ".concat(t));var c={},a=function(n){return(i?function(n,e,t){return t.then(function(t){var o=(0,r.path)([e,"#"],t),u=(0,r.prop)(e,t);return o?n.get(o).then():u})}:function(n,e){return new o.ZalgoPromise(function(t,r){var o=n.known(e);void 0!==o&&t(o),n.fetch(e).then(function(){return n.known(e)}).then(t).catch(r)})})(e,t,i).then(n||r.identity)},f=function(n){return a(l).then(n||r.identity)};return u={get:function(t){return c[t]||(c[t]=n(e,t,u))},then:a,keys:f,souls:f,count:function(n){return f(r.length).then(n||r.identity)}}};e.scope=function(n){var e,t=n.graph,c=void 0===t?{}:t,a=n.gun,l=n.parentScope,s=n.timeout,d=void 0===s?1e4:s,v=n.cache,h=void 0===v?null:v,g=n.getter,m=n.noGun,b=void 0!==m&&m,w=n.isCacheing,P=void 0!==w&&w,S=n.isCached,j=void 0!==S&&S,O=n.onlyCache,x=void 0!==O&&O,q=[],_={},k={},A={...h||{}},C={},E={...c},M=function(n,e){var t=E[n],o=t;return e&&(o=(0,r.mergeDeepRight)(t||{},e)),E[n]=o||E[n]||null,(0,r.equals)(t,o)||q.forEach(function(e){return e(n,o)}),o},Q=function(n){for(var e=arguments.length,t=new Array(e>1?e-1:0),o=1;o<e;o++)t[o-1]=arguments[o];var u=[n].concat(t).map(function(n){return"object"===i(n)?JSON.stringify(n):"".concat(n)});return[(0,r.path)(u,A),u]},T=function(n,t){for(var o=arguments.length,i=new Array(o>2?o-2:0),c=2;c<o;c++)i[c-2]=arguments[c];if(l)return l.cacheQuery.apply(l,[n,t].concat(i));var a=u(Q.apply(void 0,[n].concat(i)),2),p=a[0],s=a[1];return x?f(p):t.apply(void 0,[e].concat(i)).then(function(n){return A=P?(0,r.assocPath)(s,n,A):(0,r.dissocPath)(s,A),_=(0,r.dissocPath)(r.path,_),n})};return e={on:function(n){return q.push(n)},off:function(n){return q=q.filter(function(e){return e!==n})},get:function(n){return C[n]||(C[n]=y(e,n))},getCache:function(){return A},known:function(n){return l?l.known(n):E[n]},fetch:function(n){return l?l.fetch(n):k[n]=k[n]||new o.ZalgoPromise(function(e){var t;if(!a)return e(null);var r=function(r){clearTimeout(t),e(M(n,r))};if(t=setTimeout(function(){n in E||(console.log("slow query",n),r(null))},d),"string"!=typeof n)throw new Error("bad SOUL ".concat(n));if(g&&g(n).then(r),!b){var o=a.get(n);o.once(r),o.on(function(e){return n in E&&r(e)}),o.not&&o.not(function(){return r(null)})}})},cacheQuery:T,cachedQuery:function(n,e){for(var t=arguments.length,r=new Array(t>2?t-2:0),o=2;o<t;o++)r[o-2]=arguments[o];if(l)return l.cachedQuery.apply(l,[n,e].concat(r));var i=u(Q.apply(void 0,[n].concat(r)),1)[0],c=T.apply(void 0,[n,e].concat(r));return j&&i?f(p(i,c)):c},parentScope:l,getGraph:function(){return E},getAccesses:function(){return C},load:M,loadCachedResults:function(n){A=(0,r.mergeDeepRight)(A,n),q.forEach(function(n){return n()})}}};e.query=function(n){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,t=function(t){for(var r=arguments.length,o=new Array(r>1?r-1:0),u=1;u<r;u++)o[u-1]=arguments[u];return t.cachedQuery.apply(t,[e,n].concat(o))},o=e?t:n,u=e?t:n;return u.query=n,u.cached=o,u.now=(0,r.compose)(s,o),u}},function(e,t){e.exports=n},function(n,t){n.exports=e}])});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9ndW4tc2NvcGUvd2VicGFjay91bml2ZXJzYWxNb2R1bGVEZWZpbml0aW9uIiwid2VicGFjazovL2d1bi1zY29wZS93ZWJwYWNrL2Jvb3RzdHJhcCIsIndlYnBhY2s6Ly9ndW4tc2NvcGUvLi9zcmMvaW5kZXguanMiLCJ3ZWJwYWNrOi8vZ3VuLXNjb3BlL2V4dGVybmFsIFwicmFtZGFcIiIsIndlYnBhY2s6Ly9ndW4tc2NvcGUvZXh0ZXJuYWwgXCJ6YWxnby1wcm9taXNlXCIiXSwibmFtZXMiOlsicm9vdCIsImZhY3RvcnkiLCJleHBvcnRzIiwibW9kdWxlIiwicmVxdWlyZSIsImRlZmluZSIsImFtZCIsInNlbGYiLCJ0aGlzIiwiX19XRUJQQUNLX0VYVEVSTkFMX01PRFVMRV9fMV9fIiwiX19XRUJQQUNLX0VYVEVSTkFMX01PRFVMRV9fMl9fIiwiaW5zdGFsbGVkTW9kdWxlcyIsIl9fd2VicGFja19yZXF1aXJlX18iLCJtb2R1bGVJZCIsImkiLCJsIiwibW9kdWxlcyIsImNhbGwiLCJtIiwiYyIsImQiLCJuYW1lIiwiZ2V0dGVyIiwibyIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZW51bWVyYWJsZSIsImdldCIsInIiLCJTeW1ib2wiLCJ0b1N0cmluZ1RhZyIsInZhbHVlIiwidCIsIm1vZGUiLCJfX2VzTW9kdWxlIiwibnMiLCJjcmVhdGUiLCJrZXkiLCJiaW5kIiwibiIsIm9iamVjdCIsInByb3BlcnR5IiwicHJvdG90eXBlIiwiaGFzT3duUHJvcGVydHkiLCJwIiwicyIsIl9yYW1kYSIsIl96YWxnb1Byb21pc2UiLCJQcm9taXNlIiwiWmFsZ29Qcm9taXNlIiwiYWxsIiwicmVzb2x2ZSIsIm5vZGVLZXlzIiwib2JqIiwia2V5cyIsImZpbHRlciIsIm5vd09yIiwiY3VycnkiLCJkZWZhdWx0VmFsdWUiLCJwcm9taXNlIiwicmVzdWx0IiwicmVzb2x2ZWQiLCJ0aGVuIiwicmVzIiwibm93IiwidW5kZWZpbmVkIiwiYWNjZXNzIiwic2NvcGUiLCJ0aGlzYWNjZXNzIiwicGFjY2VzcyIsImFyZ3VtZW50cyIsImxlbmd0aCIsIkVycm9yIiwiY29uY2F0IiwiYWNjZXNzZXMiLCJmbiIsInBhcmVudGFjY2VzcyIsImRhdGEiLCJzb3VsIiwicGF0aCIsInZhbCIsInByb3AiLCJvayIsImZhaWwiLCJrbm93biIsImZldGNoIiwiY2F0Y2giLCJpZGVudGl0eSIsImdLZXkiLCJzb3VscyIsImNvdW50IiwiX3JlZiIsInRoaXNTY29wZSIsIl9yZWYkZ3JhcGgiLCJncmFwaCIsImRlZmF1bHRHcmFwaCIsImd1biIsInBhcmVudFNjb3BlIiwiX3JlZiR0aW1lb3V0IiwidGltZW91dCIsIl9yZWYkY2FjaGUiLCJjYWNoZSIsIl9yZWYkbm9HdW4iLCJub0d1biIsIl9yZWYkaXNDYWNoZWluZyIsImlzQ2FjaGVpbmciLCJfcmVmJGlzQ2FjaGVkIiwiaXNDYWNoZWQiLCJfcmVmJG9ubHlDYWNoZSIsIm9ubHlDYWNoZSIsImxpc3RlbmVycyIsImNhY2hlUHJvbWlzZXMiLCJwcm9taXNlcyIsImNhY2hlZFJlc3VsdHMiLCJsb2FkIiwiZXhpc3RpbmciLCJtZXJnZURlZXBSaWdodCIsImVxdWFscyIsImZvckVhY2giLCJnZXRDYWNoZWQiLCJfbGVuIiwiYXJncyIsIkFycmF5IiwiX2tleSIsIm1hcCIsIngiLCJfdHlwZW9mIiwiSlNPTiIsInN0cmluZ2lmeSIsImNhY2hlUXVlcnkiLCJxdWVyeUZuIiwiX2xlbjIiLCJfa2V5MiIsImFwcGx5IiwiX2dldENhY2hlZDIiLCJfc2xpY2VkVG9BcnJheSIsImNhY2hlZCIsImFzc29jUGF0aCIsImRpc3NvY1BhdGgiLCJvbiIsInB1c2giLCJvZmYiLCJnZXRDYWNoZSIsInJlYWRUaW1lb3V0IiwicmVjZWl2ZSIsImNsZWFyVGltZW91dCIsInNldFRpbWVvdXQiLCJjb25zb2xlIiwibG9nIiwiY2hhaW4iLCJvbmNlIiwibm90IiwiY2FjaGVkUXVlcnkiLCJfbGVuMyIsIl9rZXkzIiwiZ2V0R3JhcGgiLCJnZXRBY2Nlc3NlcyIsImxvYWRDYWNoZWRSZXN1bHRzIiwibmV3UmVzdWx0cyIsInNjb3BlT2JqIiwiX2xlbjQiLCJfa2V5NCIsImRvQ2FjaGVkUXVlcnkiLCJxdWVyeSIsImNvbXBvc2UiXSwibWFwcGluZ3MiOiJDQUFBLFNBQUFBLEVBQUFDLEdBQ0EsaUJBQUFDLFNBQUEsaUJBQUFDLE9BQ0FBLE9BQUFELFFBQUFELEVBQUFHLFFBQUEsU0FBQUEsUUFBQSxrQkFDQSxtQkFBQUMsZUFBQUMsSUFDQUQsT0FBQSxzQ0FBQUosR0FDQSxpQkFBQUMsUUFDQUEsUUFBQSxhQUFBRCxFQUFBRyxRQUFBLFNBQUFBLFFBQUEsa0JBRUFKLEVBQUEsYUFBQUMsRUFBQUQsRUFBQSxNQUFBQSxFQUFBLGtCQVJBLENBU0Msb0JBQUFPLFVBQUFDLEtBQUEsU0FBQUMsRUFBQUMsR0FDRCxtQkNUQSxJQUFBQyxFQUFBLEdBR0EsU0FBQUMsRUFBQUMsR0FHQSxHQUFBRixFQUFBRSxHQUNBLE9BQUFGLEVBQUFFLEdBQUFYLFFBR0EsSUFBQUMsRUFBQVEsRUFBQUUsR0FBQSxDQUNBQyxFQUFBRCxFQUNBRSxHQUFBLEVBQ0FiLFFBQUEsSUFVQSxPQU5BYyxFQUFBSCxHQUFBSSxLQUFBZCxFQUFBRCxRQUFBQyxJQUFBRCxRQUFBVSxHQUdBVCxFQUFBWSxHQUFBLEVBR0FaLEVBQUFELFFBMERBLE9BckRBVSxFQUFBTSxFQUFBRixFQUdBSixFQUFBTyxFQUFBUixFQUdBQyxFQUFBUSxFQUFBLFNBQUFsQixFQUFBbUIsRUFBQUMsR0FDQVYsRUFBQVcsRUFBQXJCLEVBQUFtQixJQUNBRyxPQUFBQyxlQUFBdkIsRUFBQW1CLEVBQUEsQ0FBMENLLFlBQUEsRUFBQUMsSUFBQUwsS0FLMUNWLEVBQUFnQixFQUFBLFNBQUExQixHQUNBLG9CQUFBMkIsZUFBQUMsYUFDQU4sT0FBQUMsZUFBQXZCLEVBQUEyQixPQUFBQyxZQUFBLENBQXdEQyxNQUFBLFdBRXhEUCxPQUFBQyxlQUFBdkIsRUFBQSxjQUFpRDZCLE9BQUEsS0FRakRuQixFQUFBb0IsRUFBQSxT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QUZ1Q0QsRUFFN0JoQixFQUFTYyxXQUFULEdBQVVoSCxHQUFWb0QsT0FBbUJnRCxJQUZVLE1BR3hDOUQsRUFBVXNFLEVBQVVJLFdBQVYsR0FBV2hILEVBQU02RyxHQUFqQnpELE9BQTZCZ0QsSUFHN0MsT0FBS2QsR0FDRTZCLEVBQVNyRixFQUFRSyxFQUFNZ0YsRUFBUTdFLElBRGhCQSxHQXFCdEJzQyxjQUNBMEQsU0FqQmUsa0JBQU03RCxHQWtCckI4RCxZQWpCa0Isa0JBQU1sRixHQWtCeEJ3QyxPQUNBMkMsa0JBbEJ3QixTQUFBQyxHQUN4QjdDLEdBQWdCLEVBQUFuRSxFQUFBc0UsZ0JBQWVILEVBQWU2QyxHQUM5Q2hELEVBQVVRLFFBQVEsU0FBQTNDLEdBQUUsT0FBSUEsaUJBcUJQLFNBQUN1RCxHQUF5QixJQUFoQjdHLEVBQWdCaUQsVUFBQUMsT0FBQSxRQUFBTixJQUFBSyxVQUFBLEdBQUFBLFVBQUEsR0FBVCxLQUM5QmtGLEVBQWMsU0FBQ08sR0FBRCxRQUFBQyxFQUFBMUYsVUFBQUMsT0FBY2tELEVBQWQsSUFBQUMsTUFBQXNDLEVBQUEsRUFBQUEsRUFBQSxLQUFBQyxFQUFBLEVBQUFBLEVBQUFELEVBQUFDLElBQWN4QyxFQUFkd0MsRUFBQSxHQUFBM0YsVUFBQTJGLEdBQUEsT0FDbEJGLEVBQVNQLFlBQVRuQixNQUFBMEIsRUFBUSxDQUFhMUksRUFBTTZHLEdBQW5CekQsT0FBK0JnRCxLQUNuQ3lDLEVBQWdCN0ksRUFBT21JLEVBQWN0QixFQUNyQ3RFLEVBQVN2QyxFQUFPbUksRUFBY3RCLEVBUXBDLE9BTkF0RSxFQUFPdUcsTUFBUWpDLEVBQ2Z0RSxFQUFPNEUsT0FBUzBCLEVBQ2hCdEcsRUFBT0ksS0FBTSxFQUFBbEIsRUFBQXNILFNBQ1hwRyxFQUNBa0csR0FFS3RHLGtCQ2hOVHpELEVBQUFELFFBQUFPLGlCQ0FBTixFQUFBRCxRQUFBUSIsImZpbGUiOiJndW4tc2NvcGUubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uIHdlYnBhY2tVbml2ZXJzYWxNb2R1bGVEZWZpbml0aW9uKHJvb3QsIGZhY3RvcnkpIHtcblx0aWYodHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnICYmIHR5cGVvZiBtb2R1bGUgPT09ICdvYmplY3QnKVxuXHRcdG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeShyZXF1aXJlKFwicmFtZGFcIiksIHJlcXVpcmUoXCJ6YWxnby1wcm9taXNlXCIpKTtcblx0ZWxzZSBpZih0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpXG5cdFx0ZGVmaW5lKFwiZ3VuLXNjb3BlXCIsIFtcInJhbWRhXCIsIFwiemFsZ28tcHJvbWlzZVwiXSwgZmFjdG9yeSk7XG5cdGVsc2UgaWYodHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnKVxuXHRcdGV4cG9ydHNbXCJndW4tc2NvcGVcIl0gPSBmYWN0b3J5KHJlcXVpcmUoXCJyYW1kYVwiKSwgcmVxdWlyZShcInphbGdvLXByb21pc2VcIikpO1xuXHRlbHNlXG5cdFx0cm9vdFtcImd1bi1zY29wZVwiXSA9IGZhY3Rvcnkocm9vdFtcInJhbWRhXCJdLCByb290W1wiemFsZ28tcHJvbWlzZVwiXSk7XG59KSh0eXBlb2Ygc2VsZiAhPT0gXCJ1bmRlZmluZWRcIiA/IHNlbGYgOiB0aGlzLCBmdW5jdGlvbihfX1dFQlBBQ0tfRVhURVJOQUxfTU9EVUxFX18xX18sIF9fV0VCUEFDS19FWFRFUk5BTF9NT0RVTEVfXzJfXykge1xucmV0dXJuICIsIiBcdC8vIFRoZSBtb2R1bGUgY2FjaGVcbiBcdHZhciBpbnN0YWxsZWRNb2R1bGVzID0ge307XG5cbiBcdC8vIFRoZSByZXF1aXJlIGZ1bmN0aW9uXG4gXHRmdW5jdGlvbiBfX3dlYnBhY2tfcmVxdWlyZV9fKG1vZHVsZUlkKSB7XG5cbiBcdFx0Ly8gQ2hlY2sgaWYgbW9kdWxlIGlzIGluIGNhY2hlXG4gXHRcdGlmKGluc3RhbGxlZE1vZHVsZXNbbW9kdWxlSWRdKSB7XG4gXHRcdFx0cmV0dXJuIGluc3RhbGxlZE1vZHVsZXNbbW9kdWxlSWRdLmV4cG9ydHM7XG4gXHRcdH1cbiBcdFx0Ly8gQ3JlYXRlIGEgbmV3IG1vZHVsZSAoYW5kIHB1dCBpdCBpbnRvIHRoZSBjYWNoZSlcbiBcdFx0dmFyIG1vZHVsZSA9IGluc3RhbGxlZE1vZHVsZXNbbW9kdWxlSWRdID0ge1xuIFx0XHRcdGk6IG1vZHVsZUlkLFxuIFx0XHRcdGw6IGZhbHNlLFxuIFx0XHRcdGV4cG9ydHM6IHt9XG4gXHRcdH07XG5cbiBcdFx0Ly8gRXhlY3V0ZSB0aGUgbW9kdWxlIGZ1bmN0aW9uXG4gXHRcdG1vZHVsZXNbbW9kdWxlSWRdLmNhbGwobW9kdWxlLmV4cG9ydHMsIG1vZHVsZSwgbW9kdWxlLmV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pO1xuXG4gXHRcdC8vIEZsYWcgdGhlIG1vZHVsZSBhcyBsb2FkZWRcbiBcdFx0bW9kdWxlLmwgPSB0cnVlO1xuXG4gXHRcdC8vIFJldHVybiB0aGUgZXhwb3J0cyBvZiB0aGUgbW9kdWxlXG4gXHRcdHJldHVybiBtb2R1bGUuZXhwb3J0cztcbiBcdH1cblxuXG4gXHQvLyBleHBvc2UgdGhlIG1vZHVsZXMgb2JqZWN0IChfX3dlYnBhY2tfbW9kdWxlc19fKVxuIFx0X193ZWJwYWNrX3JlcXVpcmVfXy5tID0gbW9kdWxlcztcblxuIFx0Ly8gZXhwb3NlIHRoZSBtb2R1bGUgY2FjaGVcbiBcdF9fd2VicGFja19yZXF1aXJlX18uYyA9IGluc3RhbGxlZE1vZHVsZXM7XG5cbiBcdC8vIGRlZmluZSBnZXR0ZXIgZnVuY3Rpb24gZm9yIGhhcm1vbnkgZXhwb3J0c1xuIFx0X193ZWJwYWNrX3JlcXVpcmVfXy5kID0gZnVuY3Rpb24oZXhwb3J0cywgbmFtZSwgZ2V0dGVyKSB7XG4gXHRcdGlmKCFfX3dlYnBhY2tfcmVxdWlyZV9fLm8oZXhwb3J0cywgbmFtZSkpIHtcbiBcdFx0XHRPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgbmFtZSwgeyBlbnVtZXJhYmxlOiB0cnVlLCBnZXQ6IGdldHRlciB9KTtcbiBcdFx0fVxuIFx0fTtcblxuIFx0Ly8gZGVmaW5lIF9fZXNNb2R1bGUgb24gZXhwb3J0c1xuIFx0X193ZWJwYWNrX3JlcXVpcmVfXy5yID0gZnVuY3Rpb24oZXhwb3J0cykge1xuIFx0XHRpZih0eXBlb2YgU3ltYm9sICE9PSAndW5kZWZpbmVkJyAmJiBTeW1ib2wudG9TdHJpbmdUYWcpIHtcbiBcdFx0XHRPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAnTW9kdWxlJyB9KTtcbiBcdFx0fVxuIFx0XHRPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7IHZhbHVlOiB0cnVlIH0pO1xuIFx0fTtcblxuIFx0Ly8gY3JlYXRlIGEgZmFrZSBuYW1lc3BhY2Ugb2JqZWN0XG4gXHQvLyBtb2RlICYgMTogdmFsdWUgaXMgYSBtb2R1bGUgaWQsIHJlcXVpcmUgaXRcbiBcdC8vIG1vZGUgJiAyOiBtZXJnZSBhbGwgcHJvcGVydGllcyBvZiB2YWx1ZSBpbnRvIHRoZSBuc1xuIFx0Ly8gbW9kZSAmIDQ6IHJldHVybiB2YWx1ZSB3aGVuIGFscmVhZHkgbnMgb2JqZWN0XG4gXHQvLyBtb2RlICYgOHwxOiBiZWhhdmUgbGlrZSByZXF1aXJlXG4gXHRfX3dlYnBhY2tfcmVxdWlyZV9fLnQgPSBmdW5jdGlvbih2YWx1ZSwgbW9kZSkge1xuIFx0XHRpZihtb2RlICYgMSkgdmFsdWUgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKHZhbHVlKTtcbiBcdFx0aWYobW9kZSAmIDgpIHJldHVybiB2YWx1ZTtcbiBcdFx0aWYoKG1vZGUgJiA0KSAmJiB0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnICYmIHZhbHVlICYmIHZhbHVlLl9fZXNNb2R1bGUpIHJldHVybiB2YWx1ZTtcbiBcdFx0dmFyIG5zID0gT2JqZWN0LmNyZWF0ZShudWxsKTtcbiBcdFx0X193ZWJwYWNrX3JlcXVpcmVfXy5yKG5zKTtcbiBcdFx0T2JqZWN0LmRlZmluZVByb3BlcnR5KG5zLCAnZGVmYXVsdCcsIHsgZW51bWVyYWJsZTogdHJ1ZSwgdmFsdWU6IHZhbHVlIH0pO1xuIFx0XHRpZihtb2RlICYgMiAmJiB0eXBlb2YgdmFsdWUgIT0gJ3N0cmluZycpIGZvcih2YXIga2V5IGluIHZhbHVlKSBfX3dlYnBhY2tfcmVxdWlyZV9fLmQobnMsIGtleSwgZnVuY3Rpb24oa2V5KSB7IHJldHVybiB2YWx1ZVtrZXldOyB9LmJpbmQobnVsbCwga2V5KSk7XG4gXHRcdHJldHVybiBucztcbiBcdH07XG5cbiBcdC8vIGdldERlZmF1bHRFeHBvcnQgZnVuY3Rpb24gZm9yIGNvbXBhdGliaWxpdHkgd2l0aCBub24taGFybW9ueSBtb2R1bGVzXG4gXHRfX3dlYnBhY2tfcmVxdWlyZV9fLm4gPSBmdW5jdGlvbihtb2R1bGUpIHtcbiBcdFx0dmFyIGdldHRlciA9IG1vZHVsZSAmJiBtb2R1bGUuX19lc01vZHVsZSA/XG4gXHRcdFx0ZnVuY3Rpb24gZ2V0RGVmYXVsdCgpIHsgcmV0dXJuIG1vZHVsZVsnZGVmYXVsdCddOyB9IDpcbiBcdFx0XHRmdW5jdGlvbiBnZXRNb2R1bGVFeHBvcnRzKCkgeyByZXR1cm4gbW9kdWxlOyB9O1xuIFx0XHRfX3dlYnBhY2tfcmVxdWlyZV9fLmQoZ2V0dGVyLCAnYScsIGdldHRlcik7XG4gXHRcdHJldHVybiBnZXR0ZXI7XG4gXHR9O1xuXG4gXHQvLyBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGxcbiBcdF9fd2VicGFja19yZXF1aXJlX18ubyA9IGZ1bmN0aW9uKG9iamVjdCwgcHJvcGVydHkpIHsgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIHByb3BlcnR5KTsgfTtcblxuIFx0Ly8gX193ZWJwYWNrX3B1YmxpY19wYXRoX19cbiBcdF9fd2VicGFja19yZXF1aXJlX18ucCA9IFwiXCI7XG5cblxuIFx0Ly8gTG9hZCBlbnRyeSBtb2R1bGUgYW5kIHJldHVybiBleHBvcnRzXG4gXHRyZXR1cm4gX193ZWJwYWNrX3JlcXVpcmVfXyhfX3dlYnBhY2tfcmVxdWlyZV9fLnMgPSAwKTtcbiIsImltcG9ydCB7XG4gIGNvbXBvc2UsXG4gIGVxdWFscyxcbiAgZGlzc29jUGF0aCxcbiAgYXNzb2NQYXRoLFxuICBjdXJyeSxcbiAgcGF0aCxcbiAgcHJvcCxcbiAgbGVuZ3RoLFxuICBpZGVudGl0eSxcbiAgbWVyZ2VEZWVwUmlnaHRcbn0gZnJvbSBcInJhbWRhXCI7XG5pbXBvcnQgeyBaYWxnb1Byb21pc2UgfSBmcm9tIFwiemFsZ28tcHJvbWlzZVwiO1xuZXhwb3J0IGNvbnN0IFByb21pc2UgPSBaYWxnb1Byb21pc2U7XG5leHBvcnQgY29uc3QgeyBhbGwsIHJlc29sdmUgfSA9IFphbGdvUHJvbWlzZTtcblxuY29uc3Qgbm9kZUtleXMgPSBvYmogPT5cbiAgT2JqZWN0LmtleXMob2JqIHx8IHt9KS5maWx0ZXIoa2V5ID0+IGtleSAmJiBrZXkgIT09IFwiX1wiICYmIGtleSAhPT0gXCIjXCIpO1xuXG5leHBvcnQgY29uc3Qgbm93T3IgPSBjdXJyeSgoZGVmYXVsdFZhbHVlLCBwcm9taXNlKSA9PiB7XG4gIGxldCByZXN1bHQ7XG4gIGxldCByZXNvbHZlZDtcblxuICBwcm9taXNlLnRoZW4ocmVzID0+IHtcbiAgICByZXNvbHZlZCA9IHRydWU7XG4gICAgcmVzdWx0ID0gcmVzO1xuICB9KTtcbiAgcmV0dXJuIHJlc29sdmVkID8gcmVzdWx0IDogZGVmYXVsdFZhbHVlO1xufSk7XG5cbmV4cG9ydCBjb25zdCBub3cgPSBub3dPcih1bmRlZmluZWQpO1xuXG5jb25zdCBub2RlID0gKHNjb3BlLCBzb3VsKSA9PlxuICBuZXcgWmFsZ29Qcm9taXNlKChvaywgZmFpbCkgPT4ge1xuICAgIGNvbnN0IGtub3duID0gc2NvcGUua25vd24oc291bCk7XG5cbiAgICBpZiAodHlwZW9mIGtub3duICE9PSBcInVuZGVmaW5lZFwiKSBvayhrbm93bik7XG4gICAgc2NvcGVcbiAgICAgIC5mZXRjaChzb3VsKVxuICAgICAgLnRoZW4oKCkgPT4gc2NvcGUua25vd24oc291bCkpXG4gICAgICAudGhlbihvaylcbiAgICAgIC5jYXRjaChmYWlsKTtcbiAgfSk7XG5cbmNvbnN0IGVkZ2UgPSAoc2NvcGUsIGtleSwgcGFyZW50YWNjZXNzKSA9PlxuICBwYXJlbnRhY2Nlc3MudGhlbihkYXRhID0+IHtcbiAgICBjb25zdCBzb3VsID0gcGF0aChba2V5LCBcIiNcIl0sIGRhdGEpO1xuICAgIGNvbnN0IHZhbCA9IHByb3Aoa2V5LCBkYXRhKTtcblxuICAgIHJldHVybiBzb3VsID8gc2NvcGUuZ2V0KHNvdWwpLnRoZW4oKSA6IHZhbDtcbiAgfSk7XG5cbmNvbnN0IGFjY2VzcyA9IChzY29wZSwga2V5LCBwYWNjZXNzID0gbnVsbCkgPT4ge1xuICBpZiAoIWtleSB8fCBrZXkgPT09IFtdKSB0aHJvdyBuZXcgRXJyb3IoYGJhZCBrZXkgJHtrZXl9YCk7XG4gIGxldCB0aGlzYWNjZXNzO1xuICBjb25zdCBhY2Nlc3NlcyA9IHt9O1xuICBjb25zdCBnZXQgPSBnS2V5ID0+XG4gICAgYWNjZXNzZXNbZ0tleV0gfHwgKGFjY2Vzc2VzW2dLZXldID0gYWNjZXNzKHNjb3BlLCBnS2V5LCB0aGlzYWNjZXNzKSk7XG4gIGNvbnN0IHRoZW4gPSBmbiA9PlxuICAgIChwYWNjZXNzID8gZWRnZSA6IG5vZGUpKHNjb3BlLCBrZXksIHBhY2Nlc3MpLnRoZW4oZm4gfHwgaWRlbnRpdHkpO1xuICBjb25zdCBrZXlzID0gZm4gPT4gdGhlbihub2RlS2V5cykudGhlbihmbiB8fCBpZGVudGl0eSk7XG4gIGNvbnN0IGNvdW50ID0gZm4gPT4ga2V5cyhsZW5ndGgpLnRoZW4oZm4gfHwgaWRlbnRpdHkpO1xuXG4gIHRoaXNhY2Nlc3MgPSB7IGdldCwgdGhlbiwga2V5cywgc291bHM6IGtleXMsIGNvdW50IH07XG4gIHJldHVybiB0aGlzYWNjZXNzO1xufTtcblxuZXhwb3J0IGNvbnN0IHNjb3BlID0gKHtcbiAgZ3JhcGg6IGRlZmF1bHRHcmFwaCA9IHt9LFxuICBndW4sXG4gIHBhcmVudFNjb3BlLFxuICB0aW1lb3V0ID0gMTAwMDAsXG4gIGNhY2hlID0gbnVsbCxcbiAgZ2V0dGVyLFxuICBub0d1biA9IGZhbHNlLFxuICBpc0NhY2hlaW5nID0gZmFsc2UsXG4gIGlzQ2FjaGVkID0gZmFsc2UsXG4gIG9ubHlDYWNoZSA9IGZhbHNlXG59KSA9PiB7XG4gIGxldCB0aGlzU2NvcGU7XG4gIGxldCBsaXN0ZW5lcnMgPSBbXTtcbiAgbGV0IGNhY2hlUHJvbWlzZXMgPSB7fTtcbiAgbGV0IHByb21pc2VzID0ge307XG4gIGxldCBjYWNoZWRSZXN1bHRzID0geyAuLi4oY2FjaGUgfHwge30pIH07XG4gIGNvbnN0IGFjY2Vzc2VzID0ge307XG4gIGNvbnN0IGdyYXBoID0geyAuLi5kZWZhdWx0R3JhcGggfTtcbiAgY29uc3QgZ2V0ID0gc291bCA9PlxuICAgIGFjY2Vzc2VzW3NvdWxdIHx8IChhY2Nlc3Nlc1tzb3VsXSA9IGFjY2Vzcyh0aGlzU2NvcGUsIHNvdWwpKTtcbiAgY29uc3Qga25vd24gPSBzb3VsID0+IChwYXJlbnRTY29wZSA/IHBhcmVudFNjb3BlLmtub3duKHNvdWwpIDogZ3JhcGhbc291bF0pO1xuICBjb25zdCBvbiA9IGZuID0+IGxpc3RlbmVycy5wdXNoKGZuKTtcbiAgY29uc3Qgb2ZmID0gZm4gPT4gKGxpc3RlbmVycyA9IGxpc3RlbmVycy5maWx0ZXIoeCA9PiB4ICE9PSBmbikpO1xuXG4gIGNvbnN0IGxvYWQgPSAoc291bCwgZGF0YSkgPT4ge1xuICAgIGNvbnN0IGV4aXN0aW5nID0gZ3JhcGhbc291bF07XG4gICAgbGV0IHJlc3VsdCA9IGV4aXN0aW5nO1xuXG4gICAgaWYgKGRhdGEpIHJlc3VsdCA9IG1lcmdlRGVlcFJpZ2h0KGV4aXN0aW5nIHx8IHt9LCBkYXRhKTtcbiAgICBncmFwaFtzb3VsXSA9IHJlc3VsdCB8fCBncmFwaFtzb3VsXSB8fCBudWxsO1xuICAgIGlmICghZXF1YWxzKGV4aXN0aW5nLCByZXN1bHQpKSBsaXN0ZW5lcnMuZm9yRWFjaChmbiA9PiBmbihzb3VsLCByZXN1bHQpKTtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9O1xuXG4gIGNvbnN0IGZldGNoID0gc291bCA9PlxuICAgIHBhcmVudFNjb3BlXG4gICAgICA/IHBhcmVudFNjb3BlLmZldGNoKHNvdWwpXG4gICAgICA6IChwcm9taXNlc1tzb3VsXSA9XG4gICAgICAgICAgcHJvbWlzZXNbc291bF0gfHxcbiAgICAgICAgICBuZXcgWmFsZ29Qcm9taXNlKG9rID0+IHtcbiAgICAgICAgICAgIGxldCByZWFkVGltZW91dDtcblxuICAgICAgICAgICAgaWYgKCFndW4pIHJldHVybiBvayhudWxsKTtcblxuICAgICAgICAgICAgY29uc3QgcmVjZWl2ZSA9IGRhdGEgPT4ge1xuICAgICAgICAgICAgICBjbGVhclRpbWVvdXQocmVhZFRpbWVvdXQpO1xuICAgICAgICAgICAgICBvayhsb2FkKHNvdWwsIGRhdGEpKTtcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIHJlYWRUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgIGlmICghKHNvdWwgaW4gZ3JhcGgpKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJzbG93IHF1ZXJ5XCIsIHNvdWwpO1xuICAgICAgICAgICAgICAgIHJlY2VpdmUobnVsbCk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sIHRpbWVvdXQpO1xuXG4gICAgICAgICAgICBpZiAodHlwZW9mIHNvdWwgIT09IFwic3RyaW5nXCIpIHRocm93IG5ldyBFcnJvcihgYmFkIFNPVUwgJHtzb3VsfWApO1xuICAgICAgICAgICAgaWYgKGdldHRlcikgZ2V0dGVyKHNvdWwpLnRoZW4ocmVjZWl2ZSk7XG4gICAgICAgICAgICBpZiAoIW5vR3VuKSB7XG4gICAgICAgICAgICAgIGNvbnN0IGNoYWluID0gZ3VuLmdldChzb3VsKTtcblxuICAgICAgICAgICAgICBjaGFpbi5vbmNlKHJlY2VpdmUpO1xuICAgICAgICAgICAgICBjaGFpbi5vbihkYXRhID0+IHNvdWwgaW4gZ3JhcGggJiYgcmVjZWl2ZShkYXRhKSk7XG4gICAgICAgICAgICAgIGlmIChjaGFpbi5ub3QpIGNoYWluLm5vdCgoKSA9PiByZWNlaXZlKG51bGwpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgICAgfSkpO1xuXG4gIGNvbnN0IGdldENhY2hlZCA9IChuYW1lLCAuLi5hcmdzKSA9PiB7XG4gICAgY29uc3Qga2V5ID0gW25hbWUsIC4uLmFyZ3NdLm1hcCh4ID0+XG4gICAgICB0eXBlb2YgeCA9PT0gXCJvYmplY3RcIiA/IEpTT04uc3RyaW5naWZ5KHgpIDogYCR7eH1gXG4gICAgKTtcblxuICAgIHJldHVybiBbcGF0aChrZXksIGNhY2hlZFJlc3VsdHMpLCBrZXldO1xuICB9O1xuXG4gIGNvbnN0IGNhY2hlUXVlcnkgPSAobmFtZSwgcXVlcnlGbiwgLi4uYXJncykgPT4ge1xuICAgIGlmIChwYXJlbnRTY29wZSkgcmV0dXJuIHBhcmVudFNjb3BlLmNhY2hlUXVlcnkobmFtZSwgcXVlcnlGbiwgLi4uYXJncyk7XG4gICAgY29uc3QgW2NhY2hlZCwga2V5XSA9IGdldENhY2hlZChuYW1lLCAuLi5hcmdzKTtcblxuICAgIGlmIChvbmx5Q2FjaGUpIHJldHVybiByZXNvbHZlKGNhY2hlZCk7XG4gICAgcmV0dXJuIHF1ZXJ5Rm4odGhpc1Njb3BlLCAuLi5hcmdzKS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICBpZiAoaXNDYWNoZWluZykge1xuICAgICAgICBjYWNoZWRSZXN1bHRzID0gYXNzb2NQYXRoKGtleSwgcmVzdWx0LCBjYWNoZWRSZXN1bHRzKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNhY2hlZFJlc3VsdHMgPSBkaXNzb2NQYXRoKGtleSwgY2FjaGVkUmVzdWx0cyk7XG4gICAgICB9XG4gICAgICBjYWNoZVByb21pc2VzID0gZGlzc29jUGF0aChwYXRoLCBjYWNoZVByb21pc2VzKTtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSk7XG4gIH07XG5cbiAgY29uc3QgY2FjaGVkUXVlcnkgPSAobmFtZSwgcXVlcnlGbiwgLi4uYXJncykgPT4ge1xuICAgIGlmIChwYXJlbnRTY29wZSkgcmV0dXJuIHBhcmVudFNjb3BlLmNhY2hlZFF1ZXJ5KG5hbWUsIHF1ZXJ5Rm4sIC4uLmFyZ3MpO1xuICAgIGNvbnN0IFtjYWNoZWRdID0gZ2V0Q2FjaGVkKG5hbWUsIC4uLmFyZ3MpO1xuICAgIGNvbnN0IHByb21pc2UgPSBjYWNoZVF1ZXJ5KG5hbWUsIHF1ZXJ5Rm4sIC4uLmFyZ3MpO1xuXG4gICAgLy8gaWYgKCFjYWNoZWQgJiYgaXNDYWNoZWQpIGNvbnNvbGUubG9nKFwiY2FjaGUgbWlzc1wiLCBuYW1lLCBhcmdzKTtcbiAgICBpZiAoIWlzQ2FjaGVkKSByZXR1cm4gcHJvbWlzZTtcbiAgICByZXR1cm4gY2FjaGVkID8gcmVzb2x2ZShub3dPcihjYWNoZWQsIHByb21pc2UpKSA6IHByb21pc2U7XG4gIH07XG5cbiAgY29uc3QgZ2V0Q2FjaGUgPSAoKSA9PiBjYWNoZWRSZXN1bHRzO1xuICBjb25zdCBnZXRHcmFwaCA9ICgpID0+IGdyYXBoO1xuICBjb25zdCBnZXRBY2Nlc3NlcyA9ICgpID0+IGFjY2Vzc2VzO1xuICBjb25zdCBsb2FkQ2FjaGVkUmVzdWx0cyA9IG5ld1Jlc3VsdHMgPT4ge1xuICAgIGNhY2hlZFJlc3VsdHMgPSBtZXJnZURlZXBSaWdodChjYWNoZWRSZXN1bHRzLCBuZXdSZXN1bHRzKTtcbiAgICBsaXN0ZW5lcnMuZm9yRWFjaChmbiA9PiBmbigpKTtcbiAgfTtcblxuICB0aGlzU2NvcGUgPSB7XG4gICAgb24sXG4gICAgb2ZmLFxuICAgIGdldCxcbiAgICBnZXRDYWNoZSxcbiAgICBrbm93bixcbiAgICBmZXRjaCxcbiAgICBjYWNoZVF1ZXJ5LFxuICAgIGNhY2hlZFF1ZXJ5LFxuICAgIHBhcmVudFNjb3BlLFxuICAgIGdldEdyYXBoLFxuICAgIGdldEFjY2Vzc2VzLFxuICAgIGxvYWQsXG4gICAgbG9hZENhY2hlZFJlc3VsdHNcbiAgfTtcbiAgcmV0dXJuIHRoaXNTY29wZTtcbn07XG5cbmV4cG9ydCBjb25zdCBxdWVyeSA9IChxdWVyeUZuLCBuYW1lID0gbnVsbCkgPT4ge1xuICBjb25zdCBjYWNoZWRRdWVyeSA9IChzY29wZU9iaiwgLi4uYXJncykgPT5cbiAgICBzY29wZU9iai5jYWNoZWRRdWVyeShuYW1lLCBxdWVyeUZuLCAuLi5hcmdzKTtcbiAgY29uc3QgZG9DYWNoZWRRdWVyeSA9IG5hbWUgPyBjYWNoZWRRdWVyeSA6IHF1ZXJ5Rm47XG4gIGNvbnN0IHJlc3VsdCA9IG5hbWUgPyBjYWNoZWRRdWVyeSA6IHF1ZXJ5Rm47XG5cbiAgcmVzdWx0LnF1ZXJ5ID0gcXVlcnlGbjtcbiAgcmVzdWx0LmNhY2hlZCA9IGRvQ2FjaGVkUXVlcnk7XG4gIHJlc3VsdC5ub3cgPSBjb21wb3NlKFxuICAgIG5vdyxcbiAgICBkb0NhY2hlZFF1ZXJ5XG4gICk7XG4gIHJldHVybiByZXN1bHQ7XG59O1xuIiwibW9kdWxlLmV4cG9ydHMgPSBfX1dFQlBBQ0tfRVhURVJOQUxfTU9EVUxFX18xX187IiwibW9kdWxlLmV4cG9ydHMgPSBfX1dFQlBBQ0tfRVhURVJOQUxfTU9EVUxFX18yX187Il0sInNvdXJjZVJvb3QiOiIifQ==